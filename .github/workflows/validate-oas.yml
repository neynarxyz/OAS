name: Validate and Lint OpenAPI Specs

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  validate-and-lint:
    name: Validate and Lint OpenAPI Specs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Node.js Environment
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: Install Validation Tools
        run: |
          npm install -g @stoplight/spectral@latest @apidevtools/swagger-cli@latest

      - name: Find OpenAPI Spec Files
        id: find_specs
        run: |
          echo "##[group]Searching for OpenAPI spec files"
          SPEC_FILES=$(find src -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.json" \))
          echo "Found the following spec files:"
          echo "$SPEC_FILES"
          echo "spec_files=$SPEC_FILES" >> $GITHUB_OUTPUT
          echo "##[endgroup]"
        shell: bash

      - name: Validate OpenAPI Spec Files
        run: |
          for file in $SPEC_FILES; do
            echo "Validating $file"
            swagger-cli validate "$file"
          done
        env:
          SPEC_FILES: ${{ steps.find_specs.outputs.spec_files }}
        shell: bash

      - name: Lint OpenAPI Spec Files
        run: |
          for file in $SPEC_FILES; do
            echo "Linting $file"
            spectral lint "$file"
          done
        env:
          SPEC_FILES: ${{ steps.find_specs.outputs.spec_files }}
        shell: bash
